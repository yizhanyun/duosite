# Work In Progress

# duosite

Duosite (duo: å¤š, many in Simplified Chinese) is a web server on top of fastify that aims to host and run many sub sites, each with its own sub setting, folder structure and template / view engine, and file system based routing  as Nextjs.

## Why duosite?

The reason to develop duosite is simple: I need a web server that allows me experiment old school html / css / js, with each site and setup indepent of each other.

The same goal can be achieved by checkouting out different branches with a different setup. The problem is that then each branch would not be visible to eachother at the same time.

Say I would like to expriment a subsite with ejs template engine and another one with marko engine. I don't want to swith branches. The two should coexist harmony. That's the staring idea of duosite.

## Current goal

The current goal is to provide a convinient environment for expirementing, teaching and studying web technology.

Why it matures, duosite may target production. But that is NOT the goal yet.

## Why choose fastify

Of course because I used it before and liked it, but also some of its cool features.

### rewriteUrl

And its has one cool feature: rewriteUrl that allows duosite to rewrite a request like `my-site-in-ejs.localhost/index.html` to `localhost/my-site-in-ejs/index.html`.

### plugin

Fastify supports plugin with `prefix`, which makes it perfect to handle each subsite's request as a plugin for a prefix.

## Development log

This section logs important ideas, design reationale and choices along the development. It is not intended to be complete and well structured but to reflect design ideas and choices down the road.

### Folder structure

duosite

```
 |- server.js : server source code
 |- settings.js : shared settings accross environment
 |- settings.development.js: settings for development only
 |- settings.production.js` : settings for production
 |- src : server source code  folder
    |- utils.js : utils used by server
    |- lang : i18n dictionary
        |- zh-cn : Ssimplified Chinese
        |- en : English
    |- engines : source code for view / template engines
 |- sites : root for sites
    |- www : default site
    |- site1 : sub site
       |- settings.js : shared settings accross environment
       |- settings.development.js: settings for development only
       |- settings.production.js` : settings for production
       |- public : folders for public files served as is. Use url <sub-site.host>/[static|bundle]/...
          |- static : static files such as images, icons etc that is going to be served as is.
          |- bundle : static files generated by bundlers like webpack or other compilers generated
                      from other sources. bundle folder can be added to `.gitignore`
       |- pages :  static html pages or templates subject to individual engine's
                   interpretation
       |- src : source code (html / template etc.)
         |- views / templates / includes / components : source code / templates etc. subject to each individual engine's interpretation
```

### Duosite server settings

Duosite server settings are composed of three files:

```
- `settings.js` : shared settings accross environment
- `settings.development.js`: settings for development only
- `settings.production.js` : settings for production
```

Eventual setting will be a deep merge of `settings.js` and`settings.development.js` in development environment, and  `settings.js` and`settings.production.js` in production environment.

### Subsite setting

Each subsite's settings for renderring each subsite.

Similar to duosite server, it has:

```
- `settings.js` : shared settings accross environment
- `settings.development.js`: settings for development only
- `settings.production.js` : settings for production
```

### Request decoration with subsite resources

When duosite is booted, each subsite's settings, view engines, plugins ( to be designed ) etc. should be initiated and passed down as property `_duosite` of `request` to handlers.

### Boot duosite

Duosite is booted with following steps:

1. load server settings
2. scan sites folder, load site list and site settings
3. initiate view engine and other plugins with site settings
4. enhance `request` with `_duosite` property, which is a object with properties and methods for the subsite's handlers to use.

### Practical Functional Programming

Duosite follows pratical functional programming principles:

1. Avoid side effects unless absolutely necessary
2. Avoid closure / external variables unless absolutely necessary
3. Avoid too much functional abstraction for code readability

### Booting functions

1. loadGlobalSettings: siteRoot => globalSettingsObject
2. enhanceGlobalSettings: globalSettingsObject => globalSettingsObject
3. buildGlobalServices: globalSettingObject => globalServicesObject
4. enahceGlobalServicesObject: (globalSettingsObject, globalServicesObject) => globalServicesObject
5. loadLocalSettings: siteRoot => localSettingObject
6. enhanceLocalSettings: localSettingObject => localSettingObject
7. buildLocalSerServices: (localSettingObject, globalServicesObject) => localServicesObject
8. enhanceLocalServices: (localSettingObject, globalServicesObject, localSericesObject) => localServicesObject

### GET try rules

When a request hit, the URL will be resovled to a handler. The handler needs to decide the rules to try different resources. Duosite follows the following rules:

1. ends with `.[non view engine ext]`: server static file.
2. ends with `.[view engine ext]`: run engine and serve output
3. ends with `/` : try `/index.html`, `/index.[view engine ext]`
4. ends with `/abc`, try `/abc.html`, `/abc.[view engine ext]`, `/abc/index.html`, `/index.[view engine ext]`
5. when resolve to view template, try to locate `abc.ext.boot.js`, run `getServerProps, getStaticProps`

### `_duosite` object

`request._duosite` has following shape:

```
{
  settings: {...}  // merged subsite settings
  engine: {...} // instantiated engine instance
  ... // TBD along development
}

```

### i18n

i18n is supported by message dictionary of messages per key or function to generate message per key for each locale with following folder structure:

```
|- src
  |- lang
  |- messages  // for server and application messages
  |- handlers  // for handlers

```

i18n will be merged in the order of <duosite-source>/src/lang and <site-root>/src/lang/
site i18n will loaded from site.

### RewriteUrl

Leveraging fastify's `rewriteUrl` function, http request to `subsite.abc.com/...` is rewritten to `abc.com/subsite/...`


### Duosite enhancers

Duosite should allow developers to enhance fasity server:

- global enhancer: enhance the global fastify server
- site enhancer: enhance the local site server

### globalSettings

Sometimes server needs to pass down some sharedSettings to all subsites. Site settings can set globalSettings property.

### globalServices

Sometimes server needs to pass down global services such as database connection etc. to all subsites. Duosite booter will require this file `<root>/src/globalServices.js`, which should export default `buildGlobalServices` function with following signature:

```
const buildGlobalServices = (settings, root) => Object
```



#### Global enhancer

Booter will require this file `<root>/src/enhancer.js` to get the enhancer function, which should have following signature:

```
const enhancer = (fastify, duositeRoot, duositeSettings, globalServices) => void
```

Server booter will call enhancer with the global fastify object, siteRoot,  siteSettings and globalServices

### Local enhancer

Booter will require this file `<root>/sites/<subsite>/src/enhancer.js` to get the site enhancer function, which should have following signature:

```
const enhancer = (fastify, subsiteRoot, siteSettings, globalSettings, globalServices) => void
```

Subsite server booter will call enhancer with the global fastify object, subsiteRoot,  siteSettings, globalSettings and globalServices.
